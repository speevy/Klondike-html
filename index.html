<html>
<head>
<style>
    .card_holder, .card_holder img.card, div.card {
        width:  min(10vw, 15vh);
        max-width: min(10vw, 15vh);
    }
    .card_holder {
        display: inline-block;
        margin: min(1vw, 1vh);
    }

    div.card {
        position: absolute;
    }

    #foundations {
        position: relative;
    }

    #foundations:not([shrink='true']) {
        top: -4vh;
    }

    #foundations:not([shrink='true']) div.card {
        top: 4vh;
    }

    #foundations[shrink='true'] div.card {
        top: 3vh;
    }
</style>

</head>
<body>
    <template id="foundation_card">
        <div class="card" draggable="true" ondragstart="dragstart(event)">
            <img class="card" draggable="false" ondblclick="to_pile(event)"/>
        </div>
    </template>
    <template id="foundation_card_empty">
        <div class="card">
            <img class="card" draggable="false" />
        </div>
    </template>
    <template id="foundation_card_back">
        <div class="card">
            <img class="card" draggable="false" />
        </div>
    </template>
    <div>
        <div class="card_holder" id="p1" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"><img class="card" src="empty.svg" draggable="false"/></div>
        <div class="card_holder" id="p2" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"><img class="card" src="empty.svg" draggable="false"/></div>
        <div class="card_holder" id="p3" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"><img class="card" src="empty.svg" draggable="false"/></div>
        <div class="card_holder" id="p4" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"><img class="card" src="empty.svg" draggable="false"/></div>
        <div class="card_holder" style="visibility:hidden"></div>
        <div class="card_holder" id="d"><img class="card" ondblclick="to_pile(event)" draggable="false"/></div>
        <div class="card_holder" id="stock"><img class="card" onclick="take()" draggable="false"/></div>
    </div>

    <div id="foundations">
        <div class="card_holder" id="f1" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"></div>
        <div class="card_holder" id="f2" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"></div>
        <div class="card_holder" id="f3" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"></div>
        <div class="card_holder" id="f4" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"></div>
        <div class="card_holder" id="f5" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"></div>
        <div class="card_holder" id="f6" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"></div>
        <div class="card_holder" id="f7" ondrop="drop_handler(event)" ondragover="dragover_handler(event)"></div>
    </div>

    <script>
        const empty_card_uri = "cards/empty.svg";
        const back_card_uri = "cards/back.svg";

        const server_base_url = 'http://localhost:8000';

        let game_url;
        fetch(server_base_url + '/klondike/game', {method:'POST'})
            .then(response => {
                game_url = server_base_url + response.headers.get("location");
                fetch(game_url)
                .then(response => response.json())
                .then(json => draw_game(json))
            });
        
        function draw_game(status) {
            console.log(status);
            
            draw_deck(status.deck);

            draw_piles(status.piles);

            draw_foundations(status.foundations);
        }

        function draw_deck(status) {
            let card_uri = empty_card_uri;
            let draggable = false;
            let deck = document.getElementById("d");
            deck.removeEventListener("dragstart", dragstart);

            if (status.cards_on_waste > 0) {
                card_uri = getUriForCard(status.top_card_on_waste);
                draggable = true;
                deck.addEventListener("dragstart", dragstart);
            } 

            deck.querySelector("img.card").src = card_uri;
            deck.draggable = draggable;

            if (status.cards_on_stock > 0) {
                card_uri = back_card_uri;
            } else {
                card_uri = empty_card_uri;
            }
            
            document.getElementById("stock").querySelector("img.card").src = card_uri;
        }

        function draw_piles(status) {
            for (let i = 0; i < status.length; i++) {
                draw_pile(status[i], "p" + (i+1));
            }
        }

        function draw_pile(status, id) {
            let card_uri = empty_card_uri;
            let draggable = false;

            let pile = document.getElementById(id);
            pile.removeEventListener("dragstart", dragstart);
            
            if (status.num_cards > 0) {
                card_uri = getUriForCard(status.top_card);
                draggable = true;
                pile.addEventListener("dragstart", dragstart);
            }
            
            pile.draggable = draggable;
            pile.querySelector("img.card").src = card_uri;
        }

        function draw_foundations(status) {
            for (let i = 0; i < status.length; i++) {
                draw_foundation(status[i], "f" + (i+1));
            }

            let num_cards = status.map((foundation) => foundation.num_hidden + foundation.visible.length);
            document.getElementById("foundations").setAttribute("shrink", Math.max(...num_cards) > 10);
        }

        function draw_foundation(status, id) {
            let foundation = document.getElementById(id);

            // Remove all content
            while (foundation.firstChild) {
                foundation.firstChild.remove()
            }

            if (status.num_hidden === 0 && status.visible.length === 0) {
                let template = document.getElementById("foundation_card_empty");
                template.content.querySelector("img").src = empty_card_uri;
                foundation.appendChild(document.importNode(template.content, true));
            } else {
                let el = foundation;
                let i = 0;
                for (; i < status.num_hidden; i++) {
                    el = draw_foundation_card(el, "card_" + id + "_" + i, "foundation_card_back", back_card_uri);
                }

                for (let j = 0; j < status.visible.length; j++) {
                    el = draw_foundation_card(
                        el, 
                        "card_" + id + "_" + (i + j), 
                        "foundation_card",
                        getUriForCard(status.visible[j])
                    );
                }

            }
        }

        function draw_foundation_card(el, id, template_id, image_uri) {
            let template = document.getElementById(template_id);
            template.content.querySelector("img.card").src = image_uri;
            template.content.querySelector("div.card").setAttribute("id", id);
            el.appendChild(document.importNode(template.content, true));
            return document.getElementById(id);
        }

        function take() {
            fetch(game_url, {
                method:'PUT',
                body: JSON.stringify({"action": "take"}),
                headers:{
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(json => draw_game(json));
        }

        function getUriForCard(card) {
            let rank;
            switch (card.rank) {
                case 'ACE': rank = '1'; break;
                case 'TWO': rank = '2'; break;
                case 'THREE': rank = '3'; break;
                case 'FOUR': rank = '4'; break;
                case 'FIVE': rank = '5'; break;
                case 'SIX': rank = '6'; break;
                case 'SEVEN': rank = '7'; break;
                case 'EIGHT': rank = '8'; break;
                case 'NINE': rank = '9'; break;
                case 'TEN': rank = '10'; break;
                default: rank = card.rank.toLowerCase();
            }

            let suit = card.suit.toLowerCase().replace(/s$/, '');
            
            return 'cards/' + rank + '_' + suit + '.svg';
        }

        function move(from, to, number) {
            if (isNaN (number)) {
                number = 1;
            }

            fetch(game_url, {
                method:'PUT',
                body: JSON.stringify({"action": "move", "from": from, "to": to, "number": number}),
                headers:{
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(json => draw_game(json));
        }

        async function to_pile(event) {
            let from = event.target.closest(".card_holder").getAttribute("id");
            let i = 1;
            while (document.getElementById("p" + i)) {
                response = await fetch(game_url, {
                    method:'PUT',
                    body: JSON.stringify({"action": "move", "from": from, "to": "p" + i}),
                    headers:{
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status == 200) {
                    draw_game(await response.json());
                    break;
                }
                i++;
            }
        }

        function dragstart(event) {
            let from = event.target.closest(".card_holder").getAttribute("id");
            let number = event.target.querySelectorAll("img.card").length;
            event.dataTransfer.setData('application/json', JSON.stringify({"from": from,"number": number}));
            console.log("dragstart from: " + from + " number: " + number);
            console.log(event.target);
        }

        function dragover_handler(ev) {
            ev.preventDefault();
            ev.dataTransfer.dropEffect = "move";
        }

        function drop_handler(ev) {
            ev.preventDefault();
            const data = JSON.parse(ev.dataTransfer.getData("application/json"));
            let to = event.target.closest(".card_holder").getAttribute("id");
            console.log(data);
            console.log("to: " + to);
            move(data.from, to, data.number);
        }

    </script>
</body>

</html>